@page "/"
@using Funda.Enums;
@using Funda.Exceptions;
@using Funda.Models;
@using System.Diagnostics;
@using Funda.Services.Interfaces;

<PageTitle>Index</PageTitle>

<div class="flex flex-row h-64 justify-center items-end">
    <input type="text" placeholder="City" class="input input-bordered w-full max-w-xs" @bind="_city" />

    <select class="select select-bordered w-full max-w-xs ml-5" @bind="_selectedTypeOption">
        <option value="@FundaObjectType.Buy" selected>Buy</option>
        <option value="@FundaObjectType.Rent">Rent</option>
    </select>

    <select class="select select-bordered w-full max-w-xs ml-5" @bind="_selectedCalculationOption">
        <option value="@TopBrokersOption" selected>Top 10 Makelaars</option>
        <option value="@TopBrokersWithTuinOption">Top 10 Makelaars with tuin objects</option>
    </select>

    <button class="btn ml-10" @onclick="Calculate">Calculate</button>
</div>


<div class="flex flex-1 justify-center mt-20">
    @if(!string.IsNullOrEmpty(_errorMessage))
    {
        <h1>@_errorMessage</h1>
    }
    else if(_topBrokers?.Count > 0)
    {
        <div class="overflow-x-auto">
            <table class="table">
                <thead>
                    <tr>
                        <th></th>
                        <th>Broker Name</th>
                        <th>Number of objects in sale</th>
                    </tr>
                </thead>
                <tbody>
                    @{var index = 1;}

                    @foreach (var broker in _topBrokers)
                    {
                        <tr>
                            <th>@index</th>
                            <td>@broker.Key</td>
                            <td>@broker.Value</td>
                        </tr>

                        index++;
                    }
                </tbody>
            </table>
        </div>
    }
    else if (_progress > 0)
    {
        <div class="radial-progress text-primary" style="--value:@_progress;">@($"{_progress}%")</div>
    }
</div>


@code {
    @inject IFundaStat _fundaStat;

    private const string TopBrokersOption = "topBrokers";
    private const string TopBrokersWithTuinOption = "topBrokersWithTuin";

    private int _progress;
    private string _errorMessage;
    private string _city;
    private string _selectedCalculationOption = TopBrokersOption;
    private FundaObjectType _selectedTypeOption = FundaObjectType.Buy;
    private Dictionary<string, int> _topBrokers;

    private CancellationTokenSource _cancellationTokenSource;

    private async void Calculate()
    {
        _errorMessage = "";
        _progress = 0;
        _topBrokers = new Dictionary<string, int>();

        // cancel previous calculation
        _cancellationTokenSource?.Cancel();
        _cancellationTokenSource = new CancellationTokenSource();

        try
        {
            var withTuin = _selectedCalculationOption == TopBrokersWithTuinOption;
            _topBrokers = await _fundaStat.GetTopBrokers(_city, _selectedTypeOption, withTuin, _cancellationTokenSource.Token, UpdateProgress);
        }
        catch(RetryLimitExceededException)
        {
            _errorMessage = "It took longer than expected :( Please try again later.";
        }
        catch(OperationCanceledException ex)
        {
            Debug.WriteLine(ex);
        }

        StateHasChanged();
    }

    private void UpdateProgress(int progress)
    {
        _progress = progress;
        StateHasChanged();
    }
}
